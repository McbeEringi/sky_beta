<!DOCTYPE html>
<html lang="en">
<head prefix="og:http://ogp.me/ns#">
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<title>sky_instruments</title>
	<meta name="Description" content="McbeEringi Sky Stuff sky_instruments">
	<link rel="icon" type="image/jpeg" href="img/icon/instr.jpg">
	<link rel="icon" type="image/svg+xml" href="img/icon/instr.svg">
	<meta property="og:type" content="website">
	<meta property="og:title" content="sky_instruments">
	<meta property="og:description" content="A web app for Sky:CotL">
	<meta property="og:url" content="https://mcbeeringi.github.io/sky_beta/instr.html">
	<meta property="og:image" content="https://mcbeeringi.github.io/sky_beta/img/icon/instr.jpg">
	<!--iOS-->
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="default">
	<meta name="apple-mobile-web-app-title" content="Sky Stuff">
	<link rel="apple-touch-icon" href="img/icon.png">
	<!--PWA-->
	<link rel="manifest" href="mf.json">
	<meta name="theme-color" content="#214">

	<link rel="stylesheet" href="https://mcbeeringi.github.io/src/toggle.css">
</head>
<body>
	<script src="util.js"></script>
	<style>
		html,body{height:100%;margin:0;overflow:hidden;position:relative;}
		body>input[type=checkbox],input[type=radio]{opacity:0;position:absolute;top:0;left:0;pointer-events:none;}

		label[for=drwcb]{position:absolute;right:0;bottom:0;--btn:48px;transition:transform .5s;--bp:-300% 0;z-index:1;}label[for=drwcb]::after{opacity:0;}:checked+label[for=drwcb]::before{--bp_:-100% -100%;}
		.drawer{width:calc(var(--btn)*4.3);max-width:100%;height:100%;padding-bottom:56px;box-sizing:border-box;position:absolute;top:0;right:0;overflow-y:auto;background-color:var(--g);transform:translateX(5%);visibility:hidden;opacity:0;transition:.2s;backdrop-filter:blur(2px);-webkit-backdrop-filter:blur(2px);}
		.drawer hr{border:0;backdrop-filter:none;-webkit-backdrop-filter:none;}.drawer hr::before{content:"";display:block;margin:0 auto;width:4px;height:4px;background:#8888;border-radius:50%;}
		#drwcb:checked~.drawer{transform:translateX(0);visibility:initial;opacity:1;}
		.prevfl{display:inline-block;box-sizing:border-box;max-width:100%;}.p16{padding:16px;}
	</style>

	<button class="btn" onpointerdown="trigger(72+q.octave+q.sc);">trg</button>

	<input type="checkbox" id="drwcb">
	<label for="drwcb" class="btn" id="drwbtn"></label>
	<div class="drawer tac">
		<div id="isel"></div>
		<hr>
		<div id="scd">
			<button class="btn" style="--bp:-300% -100%;">-
			</button><button class="btn clock" style="--bp:-100% 0;">0
			</button><button class="btn" style="--bp:-200% -100%;">+
			</button>
		</div>
		<hr>
		<button class="btn a1" style="--bp:-100% 0;" id="cfgbtn">config
		</button><button class="btn" disabled style="--bp:-400% -300%;" id="recbtn">rec
		</button><a class="btn" style="--bp:-400% -200%;" href="manual/index.html?m=instr" target="_blank">manual
		</a><button class="btn a1" style="--bp:0 0;" id="infobtn">info
		</button>
	</div>

	<script>
		'use strict';
		const esc=x=>x.replace(/[<>"'&]/g,y=>({'<':'&lt;','>':'&gt;','"':'&quot;',"'":'&apos;','&':'&amp;'})[y]),
			n2nn=x=>({c:12,d:14,e:16,f:17,g:19,a:21,b:23})[x[0].toLowerCase()]+(({'#':1,s:1})[x[1]]?x.slice(2)*12+1:x.slice(1)*12),
			nn2n=x=>['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'][x%12]+Math.floor(x/12-1),
			bp=i=>`${i%8*-100}% ${Math.floor(i*.125+1)*-100}%`,
			stdli=(a,b=a+1,s={})=>{for(let i=a;i<=b;i++){s['ds'+i]=`ds${i}.mp3`;s['a'+i]=`a${i}.mp3`;}return s;},
			irgen=(fi=.1,d=2.5,cut=10000,ch=2,rate=actx.sampleRate)=>new Promise(f=>{
				const fr=d*rate,
					oac=new(window.OfflineAudioContext||webkitOfflineAudioContext)(ch,fr,rate),
					ab=oac.createBuffer(ch,fr,rate),lpf=oac.createBiquadFilter(),g0=oac.createGain(),
					g1=oac.createGain(),bs=oac.createBufferSource();
				for(let i=0,view;i<ch;i++){view=ab.getChannelData(i);for(let j=0;j<fr;j++)view[j]=Math.random()*2-1;}
				lpf.type='lowpass';lpf.frequency.value=cut;lpf.Q.value=0;
				g0.gain.setTargetAtTime(0,0,d*.2);
				g1.gain.setValueAtTime(0,0);g1.gain.linearRampToValueAtTime(1,fi);g1.gain.setValueAtTime(1,d*.9);g1.gain.linearRampToValueAtTime(0,d);
				bs.buffer=ab;[bs,lpf,g0,g1,oac.destination].reduce((a,x)=>a.connect(x));bs.start();
				oac.startRendering();oac.oncomplete=e=>f(e.renderedBuffer);
			}),
			trigger=(n=69,{abi=0,t,out=deln}={})=>{
				const abs=actx.createBufferSource(),s=q._instr[2][abi].reduce((a,x)=>{const d=Math.abs(n-x[0]);return a[0]<d?a:[d,x];},[Infinity])[1];
				abs.playbackRate.value=Math.pow(2,(n-s[0])/12);abs.buffer=s[1];abs.connect(out);abs.start(t);
			},
			cfg=()=>{
				const e=alert(`<h2>${texts.cfg}</h2><hr>
					<h3>${texts.cfg}</h3>
					<div class="items">
						<label><div>${texts.rev}<br><input type="range" class="style" min="0" max="1" step="0.0625" value="${q.rev}" oninput="q.rev=this.value;save();"></div></label>
						<label><div>${texts.del}<br><input type="range" class="style" min="0" max=".2" step="0.0125" value="${q.del}" oninput="[72,79].forEach((x,i)=>trigger(x+q.octave+q.sc,{abi:0,t:actx.currentTime+.05+this.value*i,out:actx.destination}));q.del=this.value;save();"></div></label>
						<label><div>${texts.kbs}<br><input type="range" class="style" min="64" max="128" step="4" value="${q.kbs}"></div></label>
						<label><div>${texts.kbp}<br><input type="range" class="style" min="0" max="1" step="0.0625" value="${q.kbp}"></div></label>
						<label><div>${texts.rcv}<br><input type="checkbox" class="toggle"${q.rcv?' checked':''}></div></label>
						<label><button class="btn a1" style="--bp:-100% 0;" onclick="gcfg();"></button>${texts.gcfg}</label>
					</div>
					<h3>${texts.ci}</h3><div class="items"></div>`).e.lastElementChild,
				showci=()=>{
					e.textContent='';e.insertAdjacentHTML('beforeend',texts.loading);
					e2p(os('instr').getAllKeys())
						.then(w=>{w=w.target.result;e.textContent='';
							e.insertAdjacentHTML('beforeend',w.map((x,i)=>`<div><input type="radio" name="cisel" value="${i}" id="cisel${i}"><label for="cisel${i}" class="btn" style="--bp:0 -300%;"></label><div>${esc(x)}<br>
								<button class="btn a1 ciedt" style="--bp:-100% 0;">config</button><button class="btn cidel" style="--bp:-100% -100%;">delete</button>
							</div></div>`).join('')+`
							<label><input type="radio" name="cisel" value="-1"><p class="btn" style="--bp:0 -300%;"></p>${texts.default}</label>
							<label><button class="btn ciedt" style="--bp:-200% -100%;"></button>${texts.cnew}</label>
							`);e.offsetWidth;
							setRadio('cisel',Object.fromEntries([...w.map(Array),['',-1]])[q.ci||''],e);
							forRadio('cisel',x=>x.onchange=()=>(x.checked&&(q.ci=~x.value?w[+x.value]:'',save())),e);
							const edtfx=async i=>{
								let abs;
								const play=async (z,p)=>{p.then(()=>p=null);abs&&(abs.onended=null,abs.stop());const z_=actx.createBufferSource();z_.buffer=await new Promise(async(f,r)=>actx.decodeAudioData(await new Response(z).arrayBuffer(),f,r));p&&(z_.connect(actx.destination),z_.onended=()=>abs=null,z_.start(),abs=z_);},
									stop=()=>abs&&abs.stop(),
									opt=(y='A4')=>new Array(60).fill().map((_,j)=>`<option value="${j=nn2n(j+=36)}"${y==j?' selected':''}>${j}</option>`).join(''),
									e_=alert(`<input class="input" placeholder="${texts.cin}"><hr><div class="items">${texts.loading}</div>`),
									ls=e_.e.querySelector('.items'),add=document.createElement('button'),label=document.createElement('label'),
									a=w.length==i?{name:'',dat:[]}:(await e2p(os('instr').get(w[i]))).target.result,
									cell=(y,i)=>{
										const div=document.createElement('div'),ch=['button','div'].map(z=>document.createElement(z)),ch_=['div','button','button'].map(z=>document.createElement(z)),ch_0=()=>ch_[0].textContent=`${y[0]}: ${esc(y[1].name)}`;
										ch_0();
										ch_[1].classList.add('btn','a1');ch_[1].setAttribute('style','--bp:-100% 0;');ch_[1].textContent='config';
										ch_[1].onclick=async z=>(z=alert(`<label class="prevfl p16">${texts.keysig}: <select>${opt(y[0])}</select></label><br><label class="prevfl p16">${texts.afile}: <button>${esc(y[1].name)}</button></label>`),z.e.querySelector('button').onclick=()=>play(y[1],z.p).catch(errfx),await z.p,stop(),y[0]=z.e.querySelector('select').value,ch_0());
										ch_[2].classList.add('btn');ch_[2].setAttribute('style','--bp:-100% -100%;');ch_[2].textContent='delete';ch_[2].onclick=async()=>await yn(`<div class="tac">${texts.delask(y[0]+': '+esc(y[1].name))}</div>`).p==1&&(div.remove(),a.dat[i]=null);
										ch[0].classList.add('btn');ch[0].setAttribute('style','--bp:0 -300%;');ch[0].textContent='preview';ch[0].onclick=()=>play(y[1],e_.p).catch(errfx);
										ch[1].append(...ch_);
										div.append(...ch);return div;
									};
								add.classList.add('btn');add.setAttribute('style','--bp:-200% -100%;');add.textContent='add';
								add.onclick=async (z,ret)=>(z=alert(`<label class="prevfl p16">${texts.keysig}: <select>${opt()}</select></label><br><label class="prevfl p16">${texts.afile}: <input type="file" accept="audio/aac,audio/flac,audio/mpeg,audio/ogg,audio/opus,audio/wav,audio/webm" class="prevfl"></label>`),
									ret=z.e.querySelector('input'),ret.onchange=()=>play(ret.files[0],z.p).catch(errfx),await z.p,stop(),(ret=ret.files[0])&&(ret=[z.e.querySelector('select').value,ret])&&label.before(cell(ret,a.dat.push(ret)-1)));
								label.append(add);label.insertAdjacentHTML('beforeend',texts.cnew);
								e_.e.firstElementChild.value=a.name;
								ls.textContent='';ls.append(...a.dat.map(cell),label);
								await e_.p;stop();
								const a_={name:e_.e.firstElementChild.value||a.name||new Date().toLocaleString(),dat:a.dat.filter(y=>y)};
								a_.name==a.name?(await e2p(os('instr').put(a_)),q.ci=q.ci):(await e2p(os('instr').add(a_)),await e2p(os('instr').delete(a.name)),q.ci==a.name&&(q.ci=a_.name,save()));
								showci();
							},
							delfx=async i=>(await yn(`<div class="tac">${texts.delask(esc(w[i]))}</div>`).p==1&&(await e2p(os('instr').delete(w[i])),q.ci==w[i]&&(q.ci='',save()),showci()));
							e.querySelectorAll('.ciedt').forEach((x,i)=>x.onclick=()=>edtfx(i).catch(errfx));
							e.querySelectorAll('.cidel').forEach((x,i)=>x.onclick=()=>delfx(i).catch(errfx));
						}).catch(errfx);
				};
				showci();
			},
			deln=actx.createDelay(.5),revn=actx.createConvolver(),gn0=actx.createGain(),gn1=actx.createGain(),
			d={
				instr:[
					['musicbox/',1,[stdli(4,6,{a3:'a3.mp3',ds7:'ds7.mp3'})],0],
					['harp/',-1,[stdli(3,5)],0],//210503
					['percussion/',0,[{a4:'0.mp3',as4:'1.mp3',b4:'2.mp3',c5:'3.mp3',a5:'4.mp3',as5:'5.mp3',b5:'6.mp3',c6:'7.mp3'}],1],
					['contrabass/',-2,[stdli(2,4)],0],//211009
					['horn/',-1,[stdli(3,5)],0],//211009
					['piano/',0,[stdli(4,6)],0],//220127 +10db
						['',0,[{ds5:'musicbox/ds6.mp3',a5:'musicbox/a6.mp3'},{ds5:'glock/ds5.mp3',a5:'glock/a5.mp3'}],2],
						['bell2/',1,[{c4:'c4.mp3',d4:'d4.mp3',g4:'g4.mp3',a4:'a4.mp3'},{c4:'c4_.mp3',d4:'d4_.mp3',g4:'g4_.mp3',a4:'a4_.mp3'}],2],
					['flute/',0,[stdli(4,6)],0],//211009
					['quena/',0,[stdli(4,6)],0],//211009
					['guitar/',-1,[stdli(3,5)],0,4],//main:210503 fret:211009
					['ukulele/',-1,[stdli(3,5)],0],//211009
					['piano/',1,[stdli(5,7)],0],//220127 +10db
					['glock/',0,[stdli(4,6)],0],//210529
					['handpan/',-1,[stdli(3)],3],
					['dundun/',0,[{a4:'0.mp3',as4:'1.mp3',b4:'2.mp3',c5:'3.mp3',a5:'4.mp3',as5:'5.mp3',b5:'6.mp3',c6:'7.mp3'}],1],
					['pipa/',-1,[stdli(3,5)],0],//210529
					['bugle/',0,[stdli(4,6)],0],//210529
						['ocarina/',0,[stdli(4,6)],0],
					['kalimba/',0,[stdli(4,6)],0]//211025
				],
				i2n:[
					[-9,-7,-5,-4,-2,0,2,3,5,7,8,10,12,14,15],
					[0,1,2,3,12,13,14,15],//percussion
					[-9,-7,-2,0,-9,-7,-2,0],//bell
					[-7,0,3,5,8,10,12,15],//handpan
					[2,5,12,-10,-7,0,-22,-19,-12]//nov
				],
				i2g:[0,1,1,1,2].map(x=>[
					[5,3],
					[4,2],
					[3,3]
				][x]),
				i2p:[0,0,1,0,0].map(x=>[
					[],//undefined => 0
					[0,0,0,0,1,1,1,1]
				][x])
			},
			q={
				set instr(w){(async()=>{
					const id=q._instr_=Symbol();
					setRadio('isel',w=+w||0,isel);drwbtn.setAttribute('style',`--bp:${bp(w)};`);w=(idb.name&&!w&&q._ci)?(w=(await e2p(os('instr').get(q._ci))).target.result,[w.name,0,[w.dat],0]):[...d.instr[w]];delete q._instr;scd.classList[w[3]==1?'add':'remove']('d');
					w[2]=await Promise.all(w[2].map(x=>Promise.all((Array.isArray(x)?x:Object.entries(x)).map(async y=>(y[1]=await(typeof y[1]=='string'?await fetch('audio/instr/'+w[0]+y[1]):y[1]).arrayBuffer(),[n2nn(y[0]),await new Promise((f,r)=>actx.decodeAudioData(y[1],f,r))])))));
					q._instr_==id&&(q._instr=w,console.log(w));
				})().catch(errfx);},get instr(){return +(getRadio('isel',isel)||{value:0}).value;},
				set ci(w){q._ci=w;q.instr=q.instr;},get ci(){return q._ci;},
				set sc (w){q._sc =w=+w||0;scd.children[1].setAttribute('style',`--rot:${w*30+45}deg;`);},get sc (){return q._instr&&q._instr[3]==1?0:q._sc;},
				set rev(w){q._rev=w=+w||0;gn0.gain.value=w;gn1.gain.value=1-w;},get rev(){return q._rev;},
				set del(w){q._del=w=+w||0;deln.delayTime.value=w;},get del(){return q._del;},
				get octave(){return q._instr?q._instr[1]*12:0;},
				k2i:Object.fromEntries(Array.from('QWERTASDFGZXCVB',(x,i)=>[`Key${x}`,[i%5,Math.floor(i/5)]]))
			},
			load=()=>({ci:q._ci,instr:q.instr,sc:q.sc,rev:q.rev,del:q.del=.1}=JSON.parse(localStorage.instr_stat||'{}')),
			save=()=>localStorage.instr_stat=JSON.stringify({ci:q.ci,instr:q.instr,sc:q.sc,rev:q.rev,del:q.del});

		texts={
			...texts,
			info:'<h1>sky_instruments</h1><hr>In game sounds<br><small>recorded by @McbeEringi</small><hr><p>[sky_instr] v6 build:2207091<br><a href="https://twitter.com/mcbeeringi">@McbeEringi</a> MITLicense</p>',
			cfg:'Config',kbs:'Key Size',kbp:'Key Position',rev:'Reverb',del:'Delay',rcv:'Captures Keyboard<br>(experimental)',fbs:'Feedback Sound',
			ci:'Custom Instruments',default:'Default',cnew:'Create New…',cin:'Instrument Name',keysig:'Key Sig Name',afile:'Audio Source',
			delask:x=>`Are you sure you want to delete<br>"${x}" ?`,
			nyan:'Nyan',
			...{
				ja:{
					cfg:'設定',kbs:'鍵盤サイズ',kbp:'鍵盤位置',rev:'リバーブ',del:'遅延',rcv:'鍵盤録画の使用(試験的)',fbs:'操作音',
					ci:'カスタム楽器',default:'デフォルト',cnew:'新規作成…',cin:'楽器名',keysig:'音名',afile:'音源',
					delask:x=>`本当に<br>「${x}」<br>を削除してよろしいですか?`,
					nyan:'ﾆｬｰﾝ'
				}
			}[navigator.language.slice(0,2)]
		};
		(drwcb.onchange=()=>drwbtn.classList[drwcb.checked?'remove':'add']('a1'))();
		isel.insertAdjacentHTML('beforeend',d.instr.map((_,i)=>`<input type="radio" name="isel" value="${i}" ${[7,18].includes(i)?'disabled':''} id="isel${i}"><label class="btn a1" style="--bp:${bp(i)};" for="isel${i}"></label>`).join(''));
		forRadio('isel',x=>x.onchange=()=>(x.checked&&(q.instr=+x.value,save())),isel);
		{
			const fb=(t=actx.currentTime+.05)=>([72,76,79].forEach((x,i)=>trigger(x+q.octave+q.sc,{abi:0,t:t+i*.05,out:actx.destination})),save());
			scd.children[0].onclick=()=>{q.sc--;fb();};
			scd.children[1].onclick=()=>{q.sc=0;fb();};
			scd.children[2].onclick=()=>{q.sc++;fb();};
		}
		cfgbtn.onclick=cfg;
		infobtn.onclick=()=>alert(texts.info);

		[[deln,revn,gn0,actx.destination],[deln,gn1,actx.destination]].forEach(x=>x.reduce((a,y)=>(a.connect(y),y)));
		irgen().then(x=>revn.buffer=x);bga.g.disconnect(bga.out);bga.g.connect(bga.out=deln);
		navigator.requestMIDIAccess&&addEventListener('midiready',()=>midi.inputs.forEach(x=>x.onmidimessage=e=>({
			0:()=>console.log('noteOff',Array.from(e.data,x=>x.toString(16).padStart(2,'0'))),
			1:()=>console.log('noteOn',Array.from(e.data,x=>x.toString(16).padStart(2,'0')),e.data[2]&&trigger(e.data[1])),
		}[(e.data[0]&0x70)>>>4]||Array)()),{once:true});

		load();idb.name?(q.ci=q.ci):addEventListener('idbready',()=>q.ci=q.ci,{once:true});
</script>
</body>
</html>
